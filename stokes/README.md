stokes/
=======

Copyright 2018 Ed Bueler

The example in this directory uses [Firedrake](https://www.firedrakeproject.org/), [Gmsh](http://gmsh.info/), [PETSc](http://www.mcs.anl.gov/petsc/), and [Paraview](https://www.paraview.org/).  It is more advanced, and more experimental, than codes in `mfiles/`

Installation
------------

  * Install [Gmsh](http://gmsh.info/) and [Paraview](https://www.paraview.org/),
    for instance by installing Debian or OSX packages.
  * Follow the instructions at the
    [Firedrake download page](https://www.firedrakeproject.org/download.html)
    to install Firedrake.
  * Most users will only need the PETSc which is installed by Firedrake; no
    separate PETSc installation is needed.

Default Stokes-only usage
-------------------------

Start Firedrake and run the solver:

        $ source ~/firedrake/bin/activate

Generate the domain geometry (`.geo` file) using `gendomain.py` and then mesh
the domain (`.msh` file) using Gmsh:

        (firedrake) $ ./gendomain.py -o glacier.geo   # create domain outline
        (firedrake) $ gmsh -2 glacier.geo             # writes glacier.msh

Run the solver on the mesh:

        (firedrake) $ ./flow.py -mesh glacier.msh

This writes variables (velocity,pressure) into `glacier.pvd`.  Now visualize
using Paraview:

        (firedrake) $ paraview glacier.pvd

Alternative visualization is to plot surface values of (h,u,w) into an image file:

        (firedrake) $ ./flow.py -mesh glacier.msh -osurface foo.png

Slab-on-slope usage
-------------------

Set the height of the bedrock step to zero when creating the domain geometry:

        (firedrake) $ ./gendomain.py -bs 0.0 -o slab.geo
        (firedrake) $ gmsh -2 slab.geo
        (firedrake) $ ./flow.py -mesh slab.msh

Surface evolution usage
-----------------------

By setting `-deltat` to a positive value, and choosing the number of time steps by `-m`, the surface will evolve.  For example,

        (firedrake) $ ./flow.py -mesh glacier.msh -deltat 10.0 -m 60

This writes variables (velocity,pressure,vertical\_displacement) into `glacier.pvd` at each time step.  Paraview can show an animation.

The alternate visualization will plot final-time-only surface values of (h,u,w,h_t) into the image file:

        (firedrake) $ ./flow.py -mesh glacier.msh -deltat 10.0 -m 60 -osurface foo.png

Mesh refinement
---------------

The default mesh has a typical mesh size of 100 m with refinement by a factor of 4 near the interior corner created by the bedrock step.  (Giving 25 m resolution at the corner.)

The script `gendomain.py` allows setting the target mesh size (`-hmesh H`) and/or setting a uniform refinement factor (`-refine X`).  Another option controls the factor used for additional refinement at the interior corner (`-refine_corner Y`).  The default case corresponds to `-hmesh 100 -refine 1 -refine_corner 4`.  For example the following creates a mesh with target mesh size varying from 25 m to about 3 m near the interior corner.  The resulting grid has about 15 times as many elements as the default mesh:

        (firedrake) $ ./gendomain.py -refine 4 -refine_corner 8 -o finer.geo
        (firedrake) $ gmsh -2 finer.geo
        (firedrake) $ ./flow.py -mesh finer.msh

Alternatively one can use Gmsh to refine an existing mesh in `.msh`, specifically by splitting each triangular cell (element) into four similar triangles.  For example:

        (firedrake) $ gmsh -refine glacier.msh -o refined.msh

The triangles generated by this latter route may be better-behaved for time-dependent (i.e. surface evolving) solutions.

Getting help
------------

There are several ways to get help, but note that the `-mesh` option is required
to get going:

  * `./flow.py -flowhelp` shows options specific to `flow.py` itself,
  * `./flow.py -mesh X.msh -help` lists a large number of PETSc options, and
  * `./flow.py -mesh X.msh -help intro` shows the PETSc version number.

Solver performance information
------------------------------

Firedrake calls PETSc to solve the Glen-Stokes equations.  Because this is a nonlinear problem, the SNES object from PETSc is used.  Also, the solver is referred-to using option prefix `-s_`.  Therefore basic information on solver performance comes, for example, from asking for the number of iterations in each solver, for example

        (firedrake) $ ./flow.py -mesh glacier.msh -deltat 10.0 -m 10 -s_snes_monitor -s_snes_converged_reason

For another example, a direct linear solver for each Newton step, and PETSc documentation on the solver, is chosen by

        (firedrake) $ ./flow.py -mesh glacier.msh -s_snes_view -s_mat_type aij -s_ksp_type preonly -s_pc_type lu

To explain, the usual matrix type for this solver is `nest`, but it does not work directly with LU.  Insider the SNES solver are KSP (Krylov space) and PC (preconditioner) components.  For more on PETSc and Firedrake solvers see their documentation or my book, [_PETSc for PDEs_](https://github.com/bueler/p4pdes).

One can write-out the system matrix as a Matlab file `matrix.m` as follows:

        (firedrake) $ ./flow.py -mesh glacier.msh -s_mat_type aij -s_ksp_view_mat :matrix.m:ascii_matlab

See the default PETSc solver options in `physics.py`.

In time-stepping mode there is a second solver which computes the mesh vertical displacement field by solving Laplace's equation.  It has option prefix `-vd_` and it is defined, with default options, in `meshactions.py`.

Info on using Firedrake
-----------------------

  * `unset PETSC_DIR` and `unset PETSC_ARCH` may be needed before running `activate` when starting Firedrake
  * do `python3 firedrake-status` in the `firedrake/bin/` directory, after running `activate`, to see the current configuration of your firedrake installation

